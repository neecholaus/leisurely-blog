{{ define "content" }}
<h2>Create draft</h2>
<p id="last-saved"></p>
<input type="text" id="draft-title" placeholder="Title" />
<textarea id="draft-content" placeholder="Share something meaningful..."></textarea>
<div style="display:flex;justify-content:end;gap:5px;">
    <button class="btn">Delete</button>
    <button class="btn">Preview</button>
</div>

<style>
    #draft-content {
        width: 100%;
        min-width: 100%;
        font-family: Garamond, serif;
        font-weight: inherit;
        letter-spacing: .093em;
        background: transparent;
        border: none;
        border-bottom: solid 1px rgba(0,0,0,0.1);
        font-size: 16px;
        height: 50vh;
        min-height: fit-content;
    }
    #draft-content:focus,
    #draft-content:active {
        outline: none;
        box-shadow: none;
    }
</style>

<script>
    class DraftComposer {
        #lastUsedTitle = null;

        #pendingSave = null;

        elements = {
            lastSaved: document.querySelector('#last-saved'),
            title: document.querySelector('#draft-title'),
            content: document.querySelector('#draft-content'),
        }

        constructor() {
            const fn = () => {
                this.#handleDraftChange();
            }
            this.elements.title.addEventListener('keyup', fn);
            this.elements.content.addEventListener('keyup', fn);
        }

        #handleDraftChange() {
            if (this.#pendingSave != null) {
                clearTimeout(this.#pendingSave);
            }

            this.#pendingSave = setTimeout(() => {
                this.save();
            }, 200);
        }

        async save() {
            this.#pendingSave = null;
            const res = await fetch('/save-draft', {
                method: 'POST',
                headers: {
                    'content-type': 'application/json',
                },
                body: JSON.stringify({
                    lastUsedTitle: this.#lastUsedTitle,
                    title: this.elements.title.value, 
                    content: this.elements.content.value,
                })
            });

            const resBody = await res.json();

            this.elements.title.value = resBody.title;

            this.#rememberTitle(this.elements.title.value);

            this.elements.lastSaved.textContent = (new Date).toLocaleString();
        }

        #rememberTitle(title) {
            this.#lastUsedTitle = title;
        }
    }

    new DraftComposer();
</script>
{{ end }}